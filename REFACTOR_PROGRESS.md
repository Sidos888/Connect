# Messaging Scalability Refactor - Progress Report

**Date**: Current Session
**Status**: Phase 1 & 2 Complete, Phase 3-5 In Progress

## ‚úÖ Completed

### Phase 1: Database Migrations (COMPLETE)

- ‚úÖ Created `sql/migration_01_add_seq_and_status.sql`
  - Adds seq, client_generated_id, status columns
  - Creates unique indexes for data integrity
  - Creates performance indexes
  - Includes backfill logic for existing messages
  - Full rollback instructions included

- ‚úÖ Created `sql/migration_02_triggers_and_functions.sql`
  - `assign_message_seq()` function and trigger
  - `mark_messages_as_read()` RPC function
  - `mark_messages_as_delivered()` RPC function
  - `get_unread_count()` helper function
  - `get_latest_seq()` helper function
  - All functions granted to authenticated users

- ‚úÖ Created `sql/migration_03_realtime_publication.sql`
  - Sets REPLICA IDENTITY FULL on all chat tables
  - Adds tables to supabase_realtime publication
  - Includes verification queries

- ‚úÖ Created `docs/STAGING_SETUP.md`
  - Comprehensive guide for staging environment setup
  - Migration application process
  - Testing checklist
  - Performance testing guidelines
  - Rollback procedures

**Note**: Migrations NOT YET APPLIED to database. User needs to review and execute.

### Phase 2: Service Layer Refactor (70% COMPLETE)

#### ‚úÖ Utility Files Created

- ‚úÖ `src/lib/utils/network.ts`
  - `withRetry()` with exponential backoff
  - `NetworkError` class
  - `isOnline()` helper
  - `waitForOnline()` helper
  - `debounce()` and `throttle()` utilities
  - `batchWithDelay()` for rate-limited APIs

- ‚úÖ `src/lib/utils/dedupeStore.ts`
  - `DedupeStore` class with TTL and LRU eviction
  - `createCompositeKey()` helper
  - `globalMessageDedupeStore` instance
  - Automatic cleanup with periodic intervals
  - Statistics tracking

#### ‚úÖ simpleChatService.ts Updates

**Types Updated:**
- ‚úÖ `SimpleMessage` interface extended with:
  - `seq?`: number
  - `client_generated_id?`: string
  - `status?`: 'sent' | 'delivered' | 'read'
- ‚úÖ New `PendingMessage` interface for offline queue

**New Features Implemented:**
- ‚úÖ Imported network and dedupe utilities
- ‚úÖ Added `DedupeStore` instance
- ‚úÖ Added offline queue (`pendingQueue: PendingMessage[]`)
- ‚úÖ Added per-chat seq tracking (`chatLatestSeq: Map`)
- ‚úÖ Replaced old withRetry with new network utility
- ‚úÖ Updated constructor to listen for 'online' event
- ‚úÖ Updated `cleanupOldTracking()` to use `DedupeStore`

**New Methods Added:**
- ‚úÖ `flushPendingQueue()` - Process offline messages with retry
- ‚úÖ `addToPendingQueue()` - Add failed message to queue
- ‚úÖ `getPendingMessages()` - Get queue for UI display
- ‚úÖ `markMessagesAsDelivered()` - RPC call for delivery status
- ‚úÖ `markMessagesAsRead()` - RPC call for read status  
- ‚úÖ `getLatestSeq()` - Get latest seq for a chat

**Methods Refactored:**
- ‚úÖ `getChatMessages()`:
  - Now supports keyset pagination with `beforeSeq` parameter
  - Orders by seq (deterministic ordering)
  - Returns `{ messages, error, hasMore }`
  - Tracks latest seq per chat
  - Includes new seq, client_generated_id, status fields

- ‚úÖ `sendMessage()`:
  - Generates `client_generated_id` for idempotency
  - Checks `isOnline()` and queues if offline
  - Handles idempotency conflicts (23505 error)
  - Updates seq tracking
  - Uses `DedupeStore` to prevent duplicates
  - Adds to pending queue on network errors
  - Sets initial `status: 'sent'`

#### ‚è≥ TODO in simpleChatService.ts

- ‚è≥ Update `subscribeToMessages()`:
  - Add seq-based filtering (`if (newMessage.seq <= lastSeq) return`)
  - Replace processedMessages/recentMessageSignatures with DedupeStore
  - Update to include seq, client_generated_id, status in message conversion

- ‚è≥ Update `getUserChats()`:
  - Order by seq instead of created_at
  - Include seq in returned messages

- ‚è≥ Update `cleanup()` method:
  - Remove references to old processedMessages
  - Remove references to recentMessageSignatures
  - Call `dedupeStore.destroy()`

- ‚è≥ Add debounced `markMessagesAsDelivered()` calls in realtime subscriptions

## ‚è≥ In Progress / TODO

### Phase 3: Frontend Wiring (NOT STARTED)

#### UI Components to Update:

**3.1 Message Ordering**
- ‚è≥ Update `PersonalChatPanel.tsx`:
  - Sort messages by seq (with created_at fallback)
  - Handle pagination with scroll-up detection
  - Call `getChatMessages(chatId, beforeSeq)` on scroll

- ‚è≥ Update `ChatLayout.tsx`:
  - Sort conversation previews by last_message seq
  - Update realtime handlers to use seq

- ‚è≥ Update `src/lib/store.ts`:
  - Add `pendingMessages: PendingMessage[]` to state
  - Add actions: `addPendingMessage`, `removePendingMessage`, `flushPendingMessages`
  - Update `loadConversations` to use seq ordering
  - Wire to `simpleChatService` offline queue

**3.2 Optional Delivery Status Ticks**
- ‚è≥ Update `MessageBubble.tsx`:
  - Add optional status rendering:
    ```tsx
    {message.status === 'sent' && '‚úì'}
    {message.status === 'delivered' && '‚úì‚úì'}
    {message.status === 'read' && <span className="text-blue-500">‚úì‚úì</span>}
    ```
  - Only render if status present (backwards compatible)

**3.3 Call Delivery Lifecycle**
- ‚è≥ In `PersonalChatPanel.tsx`:
  - Call `markMessagesAsRead()` on chat focus/mount
  - Debounce to avoid excessive calls

### Phase 4: Testing Infrastructure (NOT STARTED)

**4.1 Setup Vitest**
- ‚è≥ Create `vitest.config.ts`
- ‚è≥ Install dependencies: `vitest @vitest/ui @testing-library/react @testing-library/jest-dom jsdom`
- ‚è≥ Create `tests/setup.ts` with mocks
- ‚è≥ Add test scripts to `package.json`

**4.2 Unit Tests**
- ‚è≥ `tests/unit/simpleChatService.test.ts`:
  - Test idempotent send (same client_generated_id = one row)
  - Test seq ordering
  - Test keyset pagination
  - Test deduplication
  - Test offline queue

- ‚è≥ `tests/unit/dedupeStore.test.ts`:
  - Test add/has/cleanup
  - Test TTL expiration
  - Test LRU behavior

- ‚è≥ `tests/unit/network.test.ts`:
  - Test retry logic
  - Test exponential backoff
  - Test auth error skip

**4.3 Integration Tests**
- ‚è≥ `tests/integration/messaging.test.ts`:
  - Setup test Supabase instance
  - Test message send ‚Üí realtime receive flow
  - Test no duplicates after optimistic replace
  - Test mark_messages_as_read RPC
  - Test mark_messages_as_delivered RPC
  - Test concurrent sends maintain seq order

### Phase 5: Documentation (NOT STARTED)

**5.1 Update MESSAGING_SYSTEM_ANALYSIS.md**
- ‚è≥ Add section on seq-based ordering
- ‚è≥ Document idempotency pattern
- ‚è≥ Document delivery lifecycle
- ‚è≥ Document offline queue
- ‚è≥ Update schema diagrams

**5.2 Create docs/messaging.md**
- ‚è≥ New columns reference
- ‚è≥ New functions reference
- ‚è≥ Service contracts
- ‚è≥ Migration guide

**5.3 Create docs/TESTING.md**
- ‚è≥ How to run tests
- ‚è≥ How to setup test Supabase project
- ‚è≥ Test coverage goals

## üî¥ Critical Next Steps (Priority Order)

1. **Apply Migrations to Staging** (MUST DO FIRST)
   - Review migration files
   - Create staging Supabase project
   - Apply migrations in order
   - Verify with test queries
   - Test with sample data

2. **Complete realtime subscription updates** in simpleChatService.ts
   - This is required for the refactor to work properly
   - Add seq filtering
   - Use DedupeStore instead of old tracking
   - Call markMessagesAsDelivered on receive

3. **Update UI to sort by seq**
   - PersonalChatPanel.tsx
   - ChatLayout.tsx  
   - store.ts loadConversations

4. **Add Zustand store offline queue support**
   - Wire to simpleChatService
   - Display pending messages in UI
   - Show retry state

5. **Test end-to-end**
   - Send messages
   - Verify order is deterministic
   - Test offline/online behavior
   - Verify no duplicates

6. **Add delivery status ticks** (optional but nice)
   - Update MessageBubble
   - Call lifecycle methods

7. **Setup testing infrastructure**
   - Even basic smoke tests are valuable

8. **Update documentation**
   - Helps future developers understand changes

## üìä Completion Estimate

- **Phase 1**: 100% ‚úÖ
- **Phase 2**: 70% ‚úÖ (Critical parts done, realtime subscriptions pending)
- **Phase 3**: 0% ‚è≥
- **Phase 4**: 0% ‚è≥
- **Phase 5**: 0% ‚è≥
- **Overall**: ~35% complete

**Estimated Time to Complete**:
- Phase 2 completion: 2-3 hours
- Phase 3 (UI): 3-4 hours
- Phase 4 (Tests): 4-6 hours (can be done incrementally)
- Phase 5 (Docs): 2-3 hours

**Total remaining**: 11-16 hours of development work

## ‚ö†Ô∏è Known Issues / Warnings

1. **Migrations not applied** - The SQL files are ready but need to be executed on staging/production

2. **realtime subscriptions not updated** - Current subscriptions don't use seq filtering or new DedupeStore yet. This may cause issues.

3. **UI still uses created_at** - Frontend components not yet updated to use seq ordering

4. **No tests yet** - Changes not covered by automated tests

5. **Type signature changes** - `getChatMessages` now returns `hasMore` in addition to messages/error. Calling code needs updates.

## üéØ Acceptance Criteria Status

- ‚è≥ All migrations run successfully (not applied yet)
- ‚è≥ RLS policies remain enforced (will verify after migration)
- ‚è≥ Messages display in deterministic order (UI not updated yet)
- ‚è≥ Duplicate messages cannot occur (deduplication implemented but not tested)
- ‚úÖ Idempotency works (implemented in sendMessage)
- ‚è≥ Keyset pagination loads older history (implemented but UI not wired)
- ‚è≥ Delivery lifecycle works (RPC functions ready, not called yet)
- ‚è≥ Offline queue retries failed sends (implemented but not tested)
- ‚è≥ Unit tests pass (not written yet)
- ‚è≥ Integration tests pass (not written yet)
- ‚è≥ No visual regressions (not tested yet)
- ‚è≥ Staging soak test (migrations not applied yet)

## üìù Notes for Next Session

1. **Start with realtime subscriptions** - This is the most critical remaining piece for Phase 2

2. **Test incrementally** - After each change, manually test to ensure no regressions

3. **Consider feature flags** - Might want to gate new features behind flags for gradual rollout

4. **Backup before migration** - Essential! Use Supabase dashboard or `pg_dump`

5. **Monitor after deployment** - Watch for errors, performance issues, duplicate messages

6. **Consider batched backfill** - If chat_messages table is very large (>100K rows), modify migration_01 to use smaller batches

## üîó References

- Plan: `/refactor-messaging-scalability.plan.md`
- Migrations: `sql/migration_*.sql`
- Utilities: `src/lib/utils/*.ts`
- Service: `src/lib/simpleChatService.ts`
- Staging Guide: `docs/STAGING_SETUP.md`

